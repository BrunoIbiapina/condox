{% extends 'base.html' %}
{% block title %}Minha Área • CondoX{% endblock %}
{% block content %}

<header class="mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <h1 class="text-2xl font-semibold tracking-tight flex items-center gap-2">
      <i data-lucide="gauge" class="w-6 h-6"></i>
      Minha Área
    </h1>
    <div class="flex items-center gap-3">
      <a href="{% url 'reservas:areas_list' %}" class="btn btn-primary"><i data-lucide="calendar-plus" class="w-4 h-4"></i> Nova reserva</a>
      <a href="{% url 'financeiro:minhas_cobrancas' %}" class="btn"><i data-lucide="wallet" class="w-4 h-4"></i> Financeiro</a>
    </div>
  </div>
  <p class="text-gray-500 text-sm mt-2">Acompanhe reservas, cobranças e comunicados do seu condomínio.</p>
</header>

<!-- Linha de “métricas” no mesmo estilo do gestor -->
<section class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
  <div class="card p-5 border-blue-200 bg-blue-50">
    <div class="text-sm text-blue-700 flex items-center gap-2">
      <i data-lucide="calendar" class="w-4 h-4"></i> Próximas reservas
    </div>
    <div class="mt-2 text-4xl font-bold text-blue-700">{{ minhas_reservas|length }}</div>
    <p class="text-xs text-blue-700/80 mt-1">Agendadas e futuras</p>
  </div>

  {% with pend=meus_lancamentos|dictsortreversed:"vencimento" %}
  <div class="card p-5 border-amber-200 bg-amber-50">
    <div class="text-sm text-amber-700 flex items-center gap-2">
      <i data-lucide="clock" class="w-4 h-4"></i> A vencer
    </div>
    <div class="mt-2 text-4xl font-bold text-amber-700">
      {{ meus_lancamentos|dictsort:"vencimento"|length }}
    </div>
    <p class="text-xs text-amber-700/80 mt-1">Cobranças do período</p>
  </div>
  {% endwith %}

  <div class="card p-5 {% if meus_lancamentos|length and meus_lancamentos.0.vencimento < hoje and not meus_lancamentos.0.pago_em %}border-red-200 bg-red-50{% else %}border-emerald-200 bg-emerald-50{% endif %}">
    <div class="text-sm {% if meus_lancamentos|length and meus_lancamentos.0.vencimento < hoje and not meus_lancamentos.0.pago_em %}text-red-700{% else %}text-emerald-700{% endif %} flex items-center gap-2">
      <i data-lucide="alert-triangle" class="w-4 h-4"></i>
      Situação financeira
    </div>
    <div class="mt-2 text-4xl font-bold {% if meus_lancamentos|length and meus_lancamentos.0.vencimento < hoje and not meus_lancamentos.0.pago_em %}text-red-700{% else %}text-emerald-700{% endif %}">
      {% if meus_lancamentos|length and meus_lancamentos.0.vencimento < hoje and not meus_lancamentos.0.pago_em %}Atenção{% else %}OK{% endif %}
    </div>
    <p class="text-xs mt-1 {% if meus_lancamentos|length and meus_lancamentos.0.vencimento < hoje and not meus_lancamentos.0.pago_em %}text-red-700/80{% else %}text-emerald-700/80{% endif %}">
      {% if meus_lancamentos|length and meus_lancamentos.0.vencimento < hoje and not meus_lancamentos.0.pago_em %}
        Existe cobrança vencida.
      {% else %}
        Sem pendências vencidas.
      {% endif %}
    </p>
  </div>
</section>

<!-- Grid principal (mesmo grid do gestor) -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-5">

  <!-- Minhas reservas -->
  <div class="card p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-semibold text-lg flex items-center gap-2">
        <i data-lucide="calendar-check" class="w-5 h-5"></i> Minhas reservas
      </h2>
      <a href="{% url 'reservas:areas_list' %}" class="text-sm link flex items-center gap-1">
        reservar <i data-lucide="arrow-right" class="w-4 h-4"></i>
      </a>
    </div>
    <ul class="divide-y divide-gray-200">
      {% for r in minhas_reservas %}
        <li class="py-3 flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="font-medium truncate">{{ r.area.nome }}</div>
            <div class="text-gray-600 text-sm mt-0.5">
              {{ r.inicio|date:'d/m/Y H:i' }} – {{ r.fim|date:'H:i' }}
            </div>
          </div>
          <span class="pill
            {% if r.inicio <= agora and r.fim > agora %}
              pill-em-uso
            {% elif r.status == 'APROVADA' %}
              pill-aprovada
            {% elif r.status == 'PENDENTE' %}
              pill-pendente
            {% else %}
              pill-cancelada
            {% endif %}">
            {% if r.inicio <= agora and r.fim > agora %}
              <i data-lucide="play-circle" class="w-3 h-3"></i>
              EM USO
            {% elif r.status == 'APROVADA' %}
              <i data-lucide="check-circle" class="w-3 h-3"></i>
              {{ r.get_status_display }}
            {% elif r.status == 'PENDENTE' %}
              <i data-lucide="clock" class="w-3 h-3"></i>
              {{ r.get_status_display }}
            {% else %}
              <i data-lucide="x-circle" class="w-3 h-3"></i>
              {{ r.get_status_display }}
            {% endif %}
          </span>
        </li>
      {% empty %}
        <li class="py-8 text-sm text-gray-500 text-center">Nenhuma reserva futura.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Assembleias -->
  <div class="card p-5">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-lg flex items-center gap-2">
        <i data-lucide="gavel" class="w-5 h-5"></i> Assembleias
        {% if assembleias_proximas %}
          <span class="ml-2 inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-600 text-white text-[10px]">!</span>
        {% endif %}
      </h2>
      <a href="{% url 'assembleias:lista' %}" class="text-sm link">ver todas →</a>
    </div>
    <ul class="divide-y divide-gray-200">
      {% for a in assembleias_proximas %}
        <li class="py-3 flex items-center justify-between">
          <div class="min-w-0 pr-3">
            <a href="{% url 'assembleias:detalhe' a.id %}" class="font-semibold truncate hover:underline">{{ a.titulo }}</a>
            <div class="text-gray-600 text-sm">{{ a.quando|date:'d/m/Y H:i' }}</div>
          </div>
          <span class="pill pill-aprovada">
            <i data-lucide="calendar" class="w-3 h-3"></i>
            Em breve
          </span>
        </li>
      {% empty %}
        <li class="py-6 text-sm text-gray-500 text-center">Nenhuma assembleia próxima.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Meus lançamentos -->
  <div class="card p-5">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-lg flex items-center gap-2">
        <i data-lucide="wallet" class="w-5 h-5"></i> Meus lançamentos
      </h2>
      <a href="{% url 'financeiro:minhas_cobrancas' %}" class="text-sm link">ver todos →</a>
    </div>
    <ul class="space-y-3">
      {% for l in meus_lancamentos %}
        <li class="flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="font-medium">R$ {{ l.valor|floatformat:2 }}</div>
            <div class="text-gray-600 text-sm">
              {{ l.competencia|date:'m/Y' }} • vence {{ l.vencimento|date:'d/m' }}
            </div>
          </div>
          <span class="pill
            {% if l.pago_em %}
              pill-pago
            {% elif l.vencimento < hoje %}
              pill-vencido
            {% else %}
              pill-pendente-pag
            {% endif %}">
            {% if l.pago_em %}
              <i data-lucide="check-circle" class="w-3 h-3"></i>
              PAGO
            {% elif l.vencimento < hoje %}
              <i data-lucide="alert-triangle" class="w-3 h-3"></i>
              VENCIDO
            {% else %}
              <i data-lucide="clock" class="w-3 h-3"></i>
              A VENCER
            {% endif %}
          </span>
        </li>
      {% empty %}
        <li class="text-gray-500 text-sm">Nenhum lançamento encontrado.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Avisos recentes & Próximos eventos -->
  <div class="card p-5">
    <h2 class="font-semibold text-lg mb-3 flex items-center gap-2">
      <i data-lucide="megaphone" class="w-5 h-5"></i> Avisos recentes
    </h2>
    <ul class="divide-y divide-gray-200">
      {% for a in avisos %}
        <li class="py-3 flex items-center justify-between">
          <span class="truncate pr-3">{{ a.titulo }}</span>
          <span class="text-gray-500 text-sm whitespace-nowrap">{{ a.criado_em|date:'d/m' }}</span>
        </li>
      {% empty %}
        <li class="py-6 text-sm text-gray-500 text-center">Sem avisos.</li>
      {% endfor %}
    </ul>
  </div>

  <div class="card p-5">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-lg flex items-center gap-2">
        <i data-lucide="calendar-days" class="w-5 h-5"></i> Próximos eventos
      </h2>
      <a href="{% url 'galeria:lista' %}" class="text-xs link">ver todos →</a>
    </div>
    <ul class="divide-y divide-gray-200">
      {% for e in eventos %}
        <li class="py-3 flex items-center justify-between">
          <div class="min-w-0 pr-3">
            <div class="font-semibold truncate">{{ e.titulo }}</div>
            <div class="text-gray-600 text-sm">
              {% if e.data %}{{ e.data|date:'d/m/Y' }}{% elif e.quando %}{{ e.quando|date:'d/m/Y' }}{% else %}—{% endif %}
              {% if e.local %} • {{ e.local }}{% endif %}
            </div>
          </div>
          <span class="pill pill-aprovada">
            <i data-lucide="calendar-days" class="w-3 h-3"></i>
            Evento
          </span>
        </li>
      {% empty %}
        <li class="py-6 text-sm text-gray-500 text-center">Nenhum evento programado.</li>
      {% endfor %}
    </ul>
  </div>

</section>
{% endblock %}